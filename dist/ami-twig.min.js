/*!
 * AMI TWIG Engine
 *
 * Version: 0.1.0
 *
 * Copyright (c) 2014-2015 The AMI Team
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 *
 */
;"use strict";if(typeof ami==="undefined"){var ami={}}ami.twig={};if(typeof exports!=="undefined"){exports.ami=ami}ami.twig.tokenizer={tokenize:function(d,t,k,j,h,p){if(j.length!==h.length){throw"`tokenDefs.length != tokenTypes.length`"}var r=[];var m=[];var b=[];var g=0;var f=d.length;var a="",o;var s;var e;var n;var q;while(g<f){o=d.charAt(0);if(o==="\n"){t++}if(k.indexOf(o)>=0){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}d=d.substring(1);g+=1;continue}s=false;for(q in j){e=this._match(d,j[q]);if(e){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}n=h[q];r.push(e);m.push(n);b.push(t);d=d.substring(e.length);g+=e.length;s=true;break}}if(s){continue}a+=o;d=d.substring(1);g+=1}if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}return{tokens:r,types:m,lines:b}},_match:function(b,c){var a;if(c instanceof RegExp){a=b.match(c);return a!==null&&this._checkNextChar(b,(((((a[0]))))))?(((((a[0]))))):null}else{a=b.indexOf(c);return a===0&&this._checkNextChar(b,c)?c:null}},_checkNextChar:function(b,a){var c=a.length;var d=b.charCodeAt(c-0);var e=b.charCodeAt(c-1);return isNaN(d)||this._alnum[d]===0||this._alnum[e]===0},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};ami.twig.expr={};ami.twig.expr.tokens={$init:function(){this.PLUS_MINUS=[this.PLUS,this.MINUS];this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD];this.NOT_PLUS_MINUS=[this.NOT,this.PLUS,this.MINUS];this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,IS:105,IS_XXX:106,CMP_OP:107,XXX_WITH:108,WITH:109,MATCHES:110,IN:111,RANGE:112,PLUS:113,MINUS:114,POWER:115,MUL:116,FLDIV:117,DIV:118,MOD:119,NOT:120,COLON:121,DOT:122,COMMA:123,PIPE:124,LP:125,RP:126,LB1:127,RB1:128,LB2:129,RB2:130,TERMINAL:131,SID:132,ARRAY:200,OBJECT:201,FUNCTION:202,VARIABLE:203};ami.twig.expr.tokens.$init();ami.twig.expr.Tokenizer=function(b,a){this._spaces=[" ","\t","\n","\r"];this._tokenDefs=["or","and","b-or","b-xor","b-and","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">","starts","ends","with","matches","in","..","+","-","**","*","//","/","%","not",":",".",",","|","(",")","[","]","{","}",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^\'])*'/,/^"(\\"|[^\"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/];this._tokenTypes=[ami.twig.expr.tokens.LOGICAL_OR,ami.twig.expr.tokens.LOGICAL_AND,ami.twig.expr.tokens.BITWISE_OR,ami.twig.expr.tokens.BITWISE_XOR,ami.twig.expr.tokens.BITWISE_AND,ami.twig.expr.tokens.IS,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.IS_XXX,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.XXX_WITH,ami.twig.expr.tokens.XXX_WITH,ami.twig.expr.tokens.WITH,ami.twig.expr.tokens.MATCHES,ami.twig.expr.tokens.IN,ami.twig.expr.tokens.RANGE,ami.twig.expr.tokens.PLUS,ami.twig.expr.tokens.MINUS,ami.twig.expr.tokens.POWER,ami.twig.expr.tokens.MUL,ami.twig.expr.tokens.FLDIV,ami.twig.expr.tokens.DIV,ami.twig.expr.tokens.MOD,ami.twig.expr.tokens.NOT,ami.twig.expr.tokens.COLON,ami.twig.expr.tokens.DOT,ami.twig.expr.tokens.COMMA,ami.twig.expr.tokens.PIPE,ami.twig.expr.tokens.LP,ami.twig.expr.tokens.RP,ami.twig.expr.tokens.LB1,ami.twig.expr.tokens.RB1,ami.twig.expr.tokens.LB2,ami.twig.expr.tokens.RB2,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.SID];this.$init=function(e,d){var c=ami.twig.tokenizer.tokenize(e,d,this._spaces,this._tokenDefs,this._tokenTypes,true);this.tokens=c.tokens;this.types=c.types;this.i=0};this.next=function(c){this.i+=c||1};this.isEmpty=function(){return this.i>=this.tokens.length};this.peekToken=function(){return this.tokens[this.i]};this.peekType=function(){return this.types[this.i]};this.checkType=function(c){if(this.i<this.tokens.length){var d=this.types[this.i];return(c instanceof Array)?(c.indexOf(d)>=0):(c===d)}return false};this.$init(b,a)};ami.twig.expr.Compiler=function(b,a){this.$init=function(d,c){this.tokenizer=new ami.twig.expr.Tokenizer(this.code=d,this.line=c);this.rootNode=this.parseFilter();if(!this.tokenizer.isEmpty()){throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"}};this.dump=function(){return this.rootNode.dump()};this.parseFilter=function(){var d=this.parseLogicalOr(),c;while(this.tokenizer.checkType(ami.twig.expr.tokens.PIPE)){this.tokenizer.next();c=this.parseFunVar(true);c.list.unshift(d);d=c}return d},this.parseLogicalOr=function(){var e=this.parseLogicalAnd(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_OR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseLogicalOr();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseLogicalAnd=function(){var e=this.parseBitwiseOr(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_AND)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseLogicalAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseOr=function(){var e=this.parseBitwiseXor(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_OR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseOr();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseXor=function(){var e=this.parseBitwiseAnd(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_XOR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseXor();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseAnd=function(){var e=this.parseComp(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_AND)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseComp=function(){var f=this.parseAddSub(),c,d,e;if(this.tokenizer.checkType(ami.twig.expr.tokens.IS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e=d;if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=null;d.nodeRight=e}if(this.tokenizer.checkType(ami.twig.expr.tokens.IS_XXX)){c=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e.nodeLeft=f;e.nodeRight=c}else{throw"syntax error, line `"+this.line+"`, keyword `defined` or `null` or `empty` or `iterable` or `even` or `odd` expected"}f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.CMP_OP)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.XXX_WITH)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()+"with");this.tokenizer.next(2);c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.MATCHES)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.IN)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseX();d.nodeLeft=f;d.nodeRight=c;f=d}}}}}return f};this.parseAddSub=function(){var e=this.parseMulDiv(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.PLUS_MINUS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseMulDiv=function(){var e=this.parsePower(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.MUL_FLDIV_DIV_MOD)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseMulDiv();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parsePower=function(){var e=this.parseNotPlusMinus(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.POWER)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parsePower();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseNotPlusMinus=function(){var e=null,c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT_PLUS_MINUS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseY();d.nodeLeft=e;d.nodeRight=c;return d}return this.parseY()};this.parseX=function(){var c;if((c=this.parseArray())){return c}if((c=this.parseObject())){return c}if((c=this.parseFunVar())){return c}if((c=this.parseTerminal())){return c}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"};this.parseY=function(){var c;if((c=this.parseGroup())){return c}if((c=this.parseArray())){return c}if((c=this.parseObject())){return c}if((c=this.parseFunVar())){return c}if((c=this.parseTerminal())){return c}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"};this.parseGroup=function(){var c;if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();c=this.parseFilter();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next();return c}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}return null};this.parseArray=function(){var d,c;if(this.tokenizer.checkType(ami.twig.expr.tokens.LB1)){this.tokenizer.next();c=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB1)){this.tokenizer.next();d=new ami.twig.expr.Node(ami.twig.expr.tokens.ARRAY,"Array");d.list=c;return d;return d}else{throw"syntax error, line `"+this.line+"`, `]` expected"}}return null};this.parseObject=function(){var c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LB2)){this.tokenizer.next();d=this._parseDoublets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB2)){this.tokenizer.next();c=new ami.twig.expr.Node(ami.twig.expr.tokens.OBJECT,"Object");c.dict=d;return c;return c}else{throw"syntax error, line `"+this.line+"`, `}` expected"}}return null};this.parseFunVar=function(d){var c,f,e;f=".";if(this.tokenizer.checkType(ami.twig.expr.tokens.SID)){f+=this.tokenizer.peekToken();this.tokenizer.next();while(this.tokenizer.checkType(ami.twig.expr.tokens.DOT)){f+=this.tokenizer.peekToken();this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.SID)){f+=this.tokenizer.peekToken();this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, id expected"}}if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();c=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, `)` expected"}e=new ami.twig.expr.Node(ami.twig.expr.tokens.FUNCTION,"ami.twig.stdlib"+f);e.list=c;return e}if(this.tokenizer.checkType(ami.twig.expr.tokens.LB1)){this.tokenizer.next();c=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB1)){this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, `]` expected"}e=new ami.twig.expr.Node(ami.twig.expr.tokens.VARIABLE,((((((("_")))))))+f);e.list=c;return e}if(d){return new ami.twig.expr.Node(ami.twig.expr.tokens.FUNCTION,"ami.twig.stdlib"+f)}else{return new ami.twig.expr.Node(ami.twig.expr.tokens.VARIABLE,((((((("_")))))))+f)}}return null};this._parseSinglets=function(){var c=[];while(this.tokenizer.checkType(ami.twig.expr.tokens.RX)===false){this._parseSinglet(c);if(this.tokenizer.checkType(ami.twig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{return c}}return c};this._parseDoublets=function(){var c={};while(this.tokenizer.checkType(ami.twig.expr.tokens.RB2)===false){this._parseDoublet(c);if(this.tokenizer.checkType(ami.twig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{return c}}return c};this._parseSinglet=function(c){c.push(this.parseFilter())},this._parseDoublet=function(c){if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){var d=this.tokenizer.peekToken();this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.COLON)){var e=this.tokenizer.peekToken();this.tokenizer.next();c[d]=this.parseFilter()}else{throw"syntax error, line `"+this.line+"`, `:` expected"}}else{throw"syntax error, line `"+this.line+"`, terminal expected"}},this.parseTerminal=function(){var e,c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){e=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.RANGE)){d=new ami.twig.expr.Node(((ami.twig.expr.tokens.RANGE)),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){c=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=e;d.nodeRight=c;return d}}else{return e}}return null};this.$init(b,a)};ami.twig.expr.Node=function(a,b){this.$init=function(c,d){this.nodeType=c;this.nodeValue=d;this.nodeLeft=null;this.nodeRight=null;this.list=[];this.dict={}};this._dump=function(e,d,h){var g=h[0],c;e.push("\tnode"+g+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];');if(this.nodeLeft){c=++h[0];d.push("\tnode"+g+" -> node"+c+";");this.nodeLeft._dump(e,d,h)}if(this.nodeRight){c=++h[0];d.push("\tnode"+g+" -> node"+c+";");this.nodeRight._dump(e,d,h)}for(var f in this.list){c=++h[0];d.push("\tnode"+g+" -> node"+c+' [label="['+f.replace(/"/g,'\\"')+']"];');this.list[f]._dump(e,d,h)}for(var f in this.dict){c=++h[0];d.push("\tnode"+g+" -> node"+c+' [label="['+f.replace(/"/g,'\\"')+']"];');this.dict[f]._dump(e,d,h)}};this.dump=function(){var d=[];var c=[];this._dump(d,c,[0]);return"digraph ast {\n\trankdir=TB;\n"+d.join("\n")+"\n"+c.join("\n")+"\n}"};this.$init(a,b)};ami.twig.engine={STATEMENT_RE:/\{\%\s*([a-zA-Z]+)\s*(.*?)\s*\%\}/m,VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,STACK_ITEM_IF_TRY_AGAIN:0,STACK_ITEM_IF_TRUE_DONE:1,STACK_ITEM_IF_TRUE_TODO:2,STACK_ITEM_FOR:3,STACK_ITEM_FILTER:4,STACK_ITEM_0:5,_newStackItem:function(c,b,a){if(!b){b=(null)}if(!a){a=[null]}return{type:c,symb:b,iter:a}},_hasToBeShown:function(a){var c=a.length-1;if(a[c].type===this.STACK_ITEM_IF_TRY_AGAIN||a[c].type===this.STACK_ITEM_IF_TRUE_DONE){return false}for(var b=0;b<c;b++){if(a[b].type===this.STACK_ITEM_IF_TRY_AGAIN){return false}}return true},render:function(s,dict){var result="";var stack=[this._newStackItem(this.STACK_ITEM_0)],lastStackItem;var m;var match;var keyword;var expression;var column_nr=0;var COLUMN_NR=0;var line=1;var parts,symb,expr,i;for(;;s=s.substr(COLUMN_NR)){lastStackItem=stack[stack.length-1];m=s.match(this.STATEMENT_RE);if(m===null){for(i in s){if(s[i]==="\n"){line++}}if(this._hasToBeShown(stack)){result+=s.replace(this.VARIABLE_RE,function(match,expression){return ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expression,line),dict)})}var msg=[];for(i=1;i<stack.length;i++){var x=stack[i].type;if(x===this.STACK_ITEM_IF_TRY_AGAIN||x===this.STACK_ITEM_IF_TRUE_DONE||x===this.STACK_ITEM_IF_TRUE_TODO){msg.push("missing keyword `endif`")}else{if(x===this.STACK_ITEM_FOR){msg.push("missing keyword `endfor`")}else{if(x===this.STACK_ITEM_FILTER){msg.push("missing keyword `endfilter`")}}}}if(msg.length>0){throw"syntax error, line `"+line+"`, "+msg.join(", ")}return result}match=m[0];keyword=m[1];expression=m[2];column_nr=m.index+0;COLUMN_NR=m.index+match.length;for(i in match){if(match[i]==="\n"){line++}}if(this._hasToBeShown(stack)){var SYMB=lastStackItem.symb;var ITER=lastStackItem.iter;if(SYMB){var DICT={};for(i in dict){DICT[i]=dict[i]}for(i in ITER){DICT[SYMB]=ITER[i];result+=s.substr(0,column_nr).replace(this.VARIABLE_RE,function(match,expression){return ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expression,line),DICT)})}}else{result+=s.substr(0,column_nr).replace(this.VARIABLE_RE,function(match,expression){return ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expression,line),dict)})}}if(keyword==="set"){parts=expression.split("=");symb=parts[0].trim();expr=parts[1].trim();var value=ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expr,line),dict);dict[symb]=value}else{if(keyword==="if"){stack.push(this._newStackItem(ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expression,line),dict)?this.STACK_ITEM_IF_TRUE_TODO:this.STACK_ITEM_IF_TRY_AGAIN))}else{if(keyword==="elseif"){if(lastStackItem.type!==this.STACK_ITEM_IF_TRY_AGAIN&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_DONE&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_TODO){throw"syntax error, line `"+line+"`, missing keyword `if`"}if(lastStackItem.type===this.STACK_ITEM_IF_TRY_AGAIN){lastStackItem.type=ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expression,line),dict)?this.STACK_ITEM_IF_TRUE_TODO:this.STACK_ITEM_IF_TRY_AGAIN}else{if(lastStackItem.type===this.STACK_ITEM_IF_TRUE_TODO){lastStackItem.type=this.STACK_ITEM_IF_TRUE_DONE}}}else{if(keyword==="else"){if(lastStackItem.type!==this.STACK_ITEM_IF_TRY_AGAIN&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_DONE&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_TODO){throw"syntax error, line `"+line+"`, missing keyword `if`"}if(lastStackItem.type===this.STACK_ITEM_IF_TRY_AGAIN){lastStackItem.type=this.STACK_ITEM_IF_TRUE_TODO}else{if(lastStackItem.type===this.STACK_ITEM_IF_TRUE_TODO){lastStackItem.type=this.STACK_ITEM_IF_TRUE_DONE}}}else{if(keyword==="endif"){if(lastStackItem.type!==this.STACK_ITEM_IF_TRY_AGAIN&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_DONE&&lastStackItem.type!==this.STACK_ITEM_IF_TRUE_TODO){throw"syntax error, line `"+line+"`, missing keyword `if`"}stack.pop()}else{if(keyword==="for"){parts=expression.split("in");symb=parts[0].trim();expr=parts[1].trim();var iter=ami.twig.expr.interpreter.eval(new ami.twig.expr.Compiler(expr,line),dict);if(!(iter instanceof Array)&&!(iter instanceof Object)&&!(iter instanceof String)&&!(typeof iter==="string")){throw"runtime error, line `"+line+"`, `"+symb+"` must be iterable"}stack.push(this._newStackItem(this.STACK_ITEM_FOR,symb,iter))}else{if(keyword==="endfor"){if(lastStackItem.type!==this.STACK_ITEM_FOR){throw"syntax error, line `"+line+"`, missing keyword `for`"}stack.pop()}else{if(keyword==="filter"){stack.push(this._newStackItem(this.STACK_ITEM_FILTER))}else{if(keyword==="endfilter"){if(lastStackItem.type!==this.STACK_ITEM_FILTER){throw"syntax error, line `"+line+"`, missing keyword `filter`"}stack.pop()}else{throw"syntax error, line `"+line+"`, unknown keyword `"+keyword+"`"}}}}}}}}}}}};ami.twig.stdlib={isDefined:function(a){return typeof a!=="undefined"},isNull:function(a){return a===null},isEmpty:function(a){return a===null||a===false||a===""||a===[]||a==={}},isNumber:function(a){return a instanceof Number||typeof a==="number"},isString:function(a){return a instanceof String||typeof a==="string"},isIterable:function(a){return a instanceof Array||a instanceof Object||a instanceof String||typeof a==="string"},isEven:function(a){return this.isNumber(a)&&(a&1)===0},isOdd:function(a){return this.isNumber(a)&&(a&1)===1},isInObject:function(a,b){if(b instanceof Array||b instanceof String||typeof b==="string"){return b.indexOf(a)>=0}if(b instanceof Object){return a in b}return false},isInRange:function(a,c,b){if(this.isNumber(c)&&this.isNumber(b)){return((((((((a)))))))>=(((((((c))))))))&&((((((((a)))))))<=(((((((b))))))))}else{if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){return(a.charCodeAt(0)>=c.charCodeAt(0))&&(a.charCodeAt(0)<=b.charCodeAt(0))}}return false},range:function(c,b,e){var d;var a=[];if(!e){e=1}if(this.isNumber(c)&&this.isNumber(b)){for(d=(((((((c)))))));d<=(((((((b)))))));d+=e){a.push((d))}}else{if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){for(d=c.charCodeAt(0);d<=b.charCodeAt(0);d+=e){a.push(String.fromCharCode(d))}}}return a},length:function(a){return this.isIterable(a)?a.length:0},first:function(a){return this.isIterable(a)&&a.length>0?a[0]:""},last:function(a){return this.isIterable(a)&&a.length>0?a[a.length-1]:""},"default":function(b,a){if(this.isString(b)&&this.isString(a)){return this.isEmpty(b)===false?b:a}return""},startsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=0;return b.indexOf(a,c)===c}return false},endsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=b.length-a.length;return b.indexOf(a,c)===c}return false},match:function(c,d){if(this.isString(c)&&this.isString(d)){var b=d.length;var a=d.lastIndexOf("/");if(b<2||a<0||d.charAt(0)!=="/"){throw"invalid regular expression `"+d+"`"}return new RegExp(d.substring(1,a+0),d.substring(a+1,b)).test(c)}return false},lower:function(a){return this.isString(a)?a.toLowerCase():""},upper:function(a){return this.isString(a)?a.toUpperCase():""},escape:function(a,b){if(this.isString(a)){if(!b||b==="html"||b==="html_attr"){a=a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}else{if(b==="js"){a=a.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"').replace(/'/g,"\\'")}else{if(b==="url"){a=encodeURIComponent(a)}}}}return a},raw:function(a){return a},replace:function(e,f){if(this.isString(e)&&f instanceof Array){var a="";var d=0;var b=e.length;while(d<b){for(var c in f){if(e.substring(d).indexOf(c)===0){a+=f[c];d+=c.length;continue}}a+=e.charAt(d++)}return a}return e},abs:function(a){return Math.abs(a)},min:function(){var c=(arguments.length===1)&&(arguments[0] instanceof Array||arguments[0] instanceof Object)?arguments[0]:arguments;var b=Number.POSITIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b>a){b=a}}return b},max:function(){var c=(arguments.length===1)&&(arguments[0] instanceof Array||arguments[0] instanceof Object)?arguments[0]:arguments;var b=Number.NEGATIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b<a){b=a}}return b}};ami.twig.expr.interpreter={_getJS:function(f){var d;var a;var e;var g;var c;var b;if(f.nodeLeft===null&&f.nodeRight===null){if(f.nodeType===ami.twig.expr.tokens.ARRAY||f.nodeType===ami.twig.expr.tokens.FUNCTION||f.nodeType===ami.twig.expr.tokens.VARIABLE){e="";for(d in f.list){e+=","+this._getJS(f.list[d])}if(e){e=e.substr(1)}if(f.nodeType===ami.twig.expr.tokens.ARRAY){return"["+e+"]"}else{if(f.nodeType===ami.twig.expr.tokens.FUNCTION){return f.nodeValue+"("+e+")"}else{if(f.nodeType===ami.twig.expr.tokens.VARIABLE){return f.nodeValue+"["+e+"]"}}}throw"internal error"}if(f.nodeType===ami.twig.expr.tokens.OBJECT){e="";for(d in f.dict){e+=","+d+":"+this._getJS(f.dict[d])}if(e){e=e.substr(1)}return"{"+e+"}"}return f.nodeValue}if(f.nodeLeft!==null&&f.nodeRight===null){b=(f.nodeType!==ami.twig.expr.tokens.NOT)?f.nodeValue:"!";return b+"("+this._getJS(f.nodeLeft)+")"}if(f.nodeLeft===null&&f.nodeRight!==null){b=(f.nodeType!==ami.twig.expr.tokens.NOT)?f.nodeValue:"!";return b+"("+this._getJS(f.nodeRight)+")"}if(f.nodeLeft!==null&&f.nodeRight!==null){switch(f.nodeType){case ami.twig.expr.tokens.IS:g=this._getJS(f.nodeLeft);switch(f.nodeRight.nodeType){case ami.twig.expr.tokens.DEFINED:return"ami.twig.stdlib.isDefined("+g+")";case ami.twig.expr.tokens.NULL:return"ami.twig.stdlib.isNull("+g+")";case ami.twig.expr.tokens.EMPTY:return"ami.twig.stdlib.isEmpty("+g+")";case ami.twig.expr.tokens.ITERABLE:return"ami.twig.stdlib.isIterable("+g+")";case ami.twig.expr.tokens.EVEN:return"ami.twig.stdlib.isEven("+g+")";case ami.twig.expr.tokens.ODD:return"ami.twig.stdlib.isOdd("+g+")"}throw"internal error";case ami.twig.expr.tokens.IN:if(f.nodeRight.nodeType!==ami.twig.expr.tokens.RANGE){g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.isInObject("+g+","+c+")"}else{a=this._getJS(f.nodeLeft);g=f.nodeRight.nodeLeft.nodeValue;c=f.nodeRight.nodeRight.nodeValue;return"ami.twig.stdlib.isInRange("+a+","+g+","+c+")"}case ami.twig.expr.tokens.STARTS:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.startsWith("+g+","+c+")";case ami.twig.expr.tokens.ENDS:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.endsWith("+g+","+c+")";case ami.twig.expr.tokens.MATCHES:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.match("+g+","+c+")";case ami.twig.expr.tokens.RANGE:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.range("+g+","+c+")";case ami.twig.expr.tokens.FLDIV:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"Math.floor("+g+"/"+c+")";case ami.twig.expr.tokens.POWER:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"Math.pow("+g+","+c+")";case ami.twig.expr.tokens.LOGICAL_OR:b="||";break;case ami.twig.expr.tokens.LOGICAL_AND:b="&&";break;case ami.twig.expr.tokens.BITWISE_OR:b="|";break;case ami.twig.expr.tokens.BITWISE_XOR:b="^";break;case ami.twig.expr.tokens.BITWISE_AND:b="&";break;default:b=f.nodeValue;break}g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"("+g+b+c+")"}},getJS:function(a){return this._getJS(a.rootNode)},eval:function(expr,_){if(!_){_={}}return eval(this._getJS(expr.rootNode))}};